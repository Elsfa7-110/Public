---
layout:     post
title:      "Exploiting Local File Inclusion using PHP Wrappers"
subtitle:   "LFI to Shell"
date:       2015-04-12 12:00:00
author:     "Snoopy, the Security Dog"
header-img: "img/post-bg-03.jpg"
---
<h3>Introduction</h3>

<p>Local File Inclusion is a common technique used to include contents of a local file on a webpage. In many cases, a vulnerability can occur when a webpage uses user controlled input as part of its file include function that is not properly sanitised. This vulnerability can be exploited by an attacker to gather useful usernames, sensitive system information as well triggering remote code execution.</p>


<p> Most common techniques of exploiting this vulnerability are
<ul>
  <li>Apache or SSH Log Poisoning</li>
  <li>Environ Log poisoning</li>
 </ul>
</p>
<p>This post will introduce the use of PHP wrappers to exploit a local file inclusion vulnerability. Using PHP wrappers, it is possible to execute commands on a server and get a remote shell.</p>

<h3>Technical Details</h3>

<p>To understand this vulnerability, take a look at the following example. The below PHP code takes a parameter called ‘page’ with the URL and any value given in the page parameter is included in the web page.</p>

<img alt="" src="http://snoopysecurity.github.io/img/lfi/lfi1.png" />

<p>The Uniform Resource Locater of the web application would look like the following</p>


<blockquote>http://vulnapplication.com/fileinc/example2.php?page=intro</blockquote>

<p>An attacker can exploit this vulnerability by injecting directory traversal characters and look for local system files such as ‘passwd’ or ‘win.ini’. It should be noted that the example does check if the given input has a .php extension. This can be bypassed by an attacker using the null byte terminator. In many systems, Null bytes are processed as string termination; thus the file extension check can be bypassed by adding %00 at the end of a user input.</p>

<img alt="" src="http://snoopysecurity.github.io/img/lfi/lfi2.png" />

<p>In certain cases, PHP Wrappers can be used to exploit this vulnerability to gain a remote shell. PHP Wrappers are streams that allow access to PHP interpreter’s input and output streams. The following PHP wrappers can be useful when probing for this vulnerability. </p>


<p> Most common techniques of exploiting this vulnerability are
<ul>
  <li><b>expect://ls</b> : Executes a command on server. This function is not enabled by default</li>
  <li><b>zip://</b> : Allows access to a file inside an archive with an arbitrary name.</li>
   <li><b>data://text/plain;base64,[command encoded in base64]</b> : Executes a system command that can be encoded different content types. This can be useful when evading application firewalls.</li>
   <li><b>php://input</b> : Allows data to be send to the target server. This can be used to get a reverse shell.</li>
   <li><b>php://filter</b> : Can be used to read files from the server and encode it in different formats. This can be very useful when retrieving an exact copy of case sensitive files such as the application source code.</li>



<p>The above table is an example of common wrappers than can be used. Furthermore, it is also possible to use the <b>http://</b>, <b>ftp://</b> or <b>data://</b> URIs to retrieve different data files without knowing its physical location. This technique is more efficient than enumerating physical path of a target system file.</p>

<img alt="" src="http://snoopysecurity.github.io/img/lfi/lfi4.png" />

<p>The Apache server status file can be retrieved by using the <b>http://</b> URI. To gain a remote shell on the server, the <b>php://input</b> wrapper can be used. The <b>php://input</b> is a read-only stream that allows a server to read raw data from the request body.
Note: This is technically a Remote file inclusion but I thought this would be an interesting read for newbies.
</p>

<img alt="" src="http://snoopysecurity.github.io/img/lfi/lfi5.png" />


<p>The above request will be processed by the server to download a malicious PHP script from an attacker controlled server. This is then saved in the var/www/ folder.  This can then be executed by browsing to the saved webpage and having a listener open for communications.</p>

<img alt="" src="http://snoopysecurity.github.io/img/lfi/lfi6.png" />

<p>To conclude, the use of PHP wrappers should always be tested when probing and fuzzing for file include vulnerabilities. Numerous fuzz payload repositories such as fuzzdb and Seclists do not contain any wrappers as part of their file inclusion fuzz payloads.</p>

<p> References : http://php.net/manual/en/wrappers.php </p>
