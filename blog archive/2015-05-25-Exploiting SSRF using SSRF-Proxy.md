---
layout:     post
title:      "Exploiting SSRF using SSRF-Proxy"
subtitle:   "A small introduction to SSRF using BWapp"
date:       2015-05-28-01 12:00:00
author:     "Snoopy, the Security Dog"
header-img: "img/contact-bg.png"
---

<h3>Introduction</h3>

<p>Web Applications are often known to take user passed values and retrieves the contents of this value without any validation which can lead to known attacks such as SQL Injection, Local File Inclusion and more. But in rare cases, this can be exploited using an attack called Server Side Request Forgery. This is a short introduction to understanding Server Side Request Forgery and exploiting applications in the wild. </p>

<p>SSRF (also known as XPSA) usually occurs when a web application attempts to connect to user supplied URLs and does not validate backend responses received from the remote server. SSRF can be used by an attacker to port scan any internet facing servers and services by creating requests from the vulnerable server. Furthermore, this attack vector can be leveraged to turn the application server against its hosted infrastructure. </p>

<p> An attacker can leverage this vulnerability to conduct the following attacks:
<ul>
  <li>Port scanning the affected server's internal network.</li>
  <li>Tunnel traffic through the vulnerable server and attack other external applications.</li>
  <li>Attack services running on the application server or on the internal Intranet.</li>
  <li>Denial of Service attacks on internal services.</li>
  <li>Access local files available to the application by using different URI schemes such as ‘file://’.</li>
</ul>
</p>

<h3>A working Example</h3>

<p>To better understand an SSRF vulnerability, take a look at the following example from Bwapp. Bwapp is a vulnerable web application used for teaching purposes. The following URL takes a user parameter and retrieves the content back to the user.</p>


<blockquote>http://192.168.0.28/bWAPP/rlfi.php?language=lang_en.php&action=go</blockquote>

<p>If you modify the 'language' parameter, it is obvious that the application is making outbound requests to other internet facing applications without any validation.

This vulnerability can be verified by forcing the application to perform outbound requests to a server you control.
</p>


<img alt="" src="http://snoopysecurity.github.io/img/ssrf/img1.png" />

<p>The vulnerable application is retrieving the contents of an external URL and returning its contents in its own response. 
To exploit this vulnerability, an attacker can to conduct port scan on other servers by sending different requests with URI schemas and understanding error distinction given by the response. For example, an attacker can see if a port 22 of scanme.nmap.org is open by sending the following request.
</p>

<blockquote>http://192.168.0.28/bWAPP/rlfi.php?language=http://scanme.nmap.org:22&action=go</blockquote>

<img alt="" src="http://snoopysecurity.github.io/img/ssrf/img2.png" />

<p>The server makes a request to scanme.nmap.org and returns the SSH header in the Bwapp application’s contents.

By enumerating through different ports, an attacker can distinguish if the port is open or not with error distinction. Furthermore, an attacker can start port scanning the local host and looking for internal services. This can be conducted manually or through fuzzers such as burp intruder or ZAP fuzzer. These types of attacks can usually bypass firewalls and web application firewalls since all traffic are proxied through the vulnerable application.

The automation of this vulnerability can be done through a tool called SSRF Proxy. SSRF Proxy is a multi-threaded HTTP proxy server designed to tunnel client HTTP traffic through HTTP servers vulnerable to Server-Side Request Forgery (SSRF). Using SSRF Proxy, an attacker can use scanning tools such as sqlmap and nikto and tunnel traffic through the SSRF vulnerable servers.
After setting up SSRF Proxy, the following command can be used to exploit a SSRF vulnerability and turn the target into a usable proxy.
</p>

<blockquote>ssrf-proxy -u "http://192.168.0.28/bWAPP/rlfi.php?language=AttackURL&action=go" --cookie "security_level=0; PHPSESSID=20bb7b9881f9a5a8505665fa01f29320" --rules urlencode</blockquote>

<img alt="" src="http://snoopysecurity.github.io/img/ssrf/img3.png"/>

<p>SSRF Proxy will now setup a local proxy and forward any send traffic to the Bwapp application.

By attacking other hosts through the proxy, an attacker can remain anonymous while trying to exploit other hosts. Since SQL Injection requires numerous malicious payloads to be sent to a server, it is a good idea to proxy malicious SQL traffic through an SSRF Proxy.

You can now tunnel traffic through the proxy by using the '--proxy http://127.0.0.1:8081' in SQLmap.
</p>

<blockquote>sqlmap.py --proxy http://127.0.0.1:8081 -u “http://examplesite.com/foo?parameter=*”</blockquote>


<h3>Mitigations</h3>

<p>Server side validation should be implemented to check all received responses and only allow whitelisted resources. All user passed values should be validated and whitelisted to access only the needed resource
Some applications will need functionality to send outbound requests. But, this should be restricted only to whitelisted resources. If possible, the application should not be allowed to make any external interaction on behalf of the user
The below sample PHP code can be used to better understand how this vulnerability is introduced into a web application.
</p>

<img alt="" src="http://snoopysecurity.github.io/img/ssrf/img4.png"/>

<p>The file_get contents PHP function is used to read a URL and send a HTTP POST request to the user passed URL without any validation. This can be exploited by a user to try a series of local IP addresses in order to determine what IP address range the internal server exist.
In certain scenarios, hiding error messages cannot be considered as mitigation for this vulnerability.  This is because the attacker can find this vulnerability by trying to make an external request to an external server controlled by the attacker. This will lead to a blind SSRF vulnerability.
</p>

